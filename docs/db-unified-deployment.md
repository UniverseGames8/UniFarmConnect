# Инструкция по развертыванию новой архитектуры модулей БД

## Обзор изменений

Новая архитектура модулей базы данных устраняет циклические зависимости и улучшает надежность соединения с БД. Разработаны следующие модули:

1. `server/db-config.ts` - Конфигурация подключения к БД
2. `server/db-health-monitor.ts` - Мониторинг состояния соединения 
3. `server/db-connect-unified.ts` - Основной модуль подключения к БД
4. `server/db-adapter.ts` - Адаптер для совместимости с существующим кодом

## Этапы развертывания

### 1. Предварительная проверка

Перед развертыванием новой архитектуры необходимо:

- Создать резервную копию базы данных
- Проверить наличие всех необходимых переменных окружения
- Убедиться, что строка подключения к БД (DATABASE_URL) корректна

### 2. Развертывание кода

1. Скопировать новые модули на production-сервер:
   - `server/db-config.ts`
   - `server/db-health-monitor.ts`
   - `server/db-connect-unified.ts`
   - `server/db-adapter.ts`

2. Обновить ссылающиеся файлы:
   - `server/index.ts`
   - `server/middleware/databaseErrorHandler.ts`

3. Добавить тестовый API-маршрут:
   - `server/api/admin/db-unified-test.ts`

### 3. Проверка развертывания

После развертывания необходимо проверить:

1. Запуск сервера без ошибок
2. Успешное подключение к базе данных
3. Тестовый API-маршрут `/api/admin/db-unified-test`

## План отката

В случае проблем с новой архитектурой:

1. Вернуть оригинальные файлы:
   - `server/db-selector.ts`
   - `server/db-health.ts`
   - `server/db-monitor.ts`
   - `server/db-connect.ts`

2. Восстановить оригинальные импорты в:
   - `server/index.ts`
   - `server/middleware/databaseErrorHandler.ts`

## Мониторинг

После развертывания необходимо мониторить:

1. Журналы сервера на предмет ошибок соединения с БД
2. Работоспособность API-эндпоинтов
3. Производительность запросов к БД

## Полезные команды

### Проверка состояния соединения

```bash
curl -X GET https://uni-farm-connect-xo-osadchukdmitro2.replit.app/api/admin/db-unified-test
```

### Проверка журналов

```bash
tail -f logs/server.log | grep -i "db\|database\|connection"
```

## Контакты для поддержки

При возникновении проблем обращаться к разработчикам: