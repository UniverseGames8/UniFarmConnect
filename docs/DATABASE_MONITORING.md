# Система мониторинга базы данных

В приложении UniFarm реализована комплексная система мониторинга состояния базы данных для обеспечения стабильной работы в продакшене.

## Основные компоненты

### 1. Система событий базы данных

Модуль `server/utils/db-events.ts` предоставляет централизованный механизм для отслеживания и реагирования на события, связанные с базой данных:

- Подключение/отключение соединения
- Переключение на резервные соединения
- Переход в режим in-memory при недоступности БД
- Ошибки запросов
- Попытки переподключения

### 2. Расширенный эндпоинт проверки здоровья системы

Эндпоинт `/api/health` предоставляет подробную информацию о:

- Текущем состоянии соединения с БД
- Последних событиях базы данных
- Статусе Telegram бота
- Системных метриках (память, время работы)

### 3. Административный эндпоинт для управления БД

Эндпоинт `/api/db/reconnect` позволяет:

- Просматривать текущую информацию о соединении
- Принудительно перезапускать соединение с БД
- Получать историю событий базы данных

### 4. Визуальная страница статуса

Страница `/status` предоставляет визуальный интерфейс для мониторинга:

- Показывает текущее состояние всех компонентов системы
- Отображает историю событий базы данных
- Автоматически обновляется каждые 30 секунд

## Использование системы мониторинга

### Просмотр состояния системы

```
GET /api/health
```

Пример ответа:
```json
{
  "status": "ok",
  "server": "up",
  "timestamp": "2025-05-22T10:15:30.123Z",
  "uptime": 3600,
  "db": {
    "status": "connected",
    "provider": "Neon.tech",
    "responseTime": "45ms",
    "recentEvents": [...]
  },
  "telegram": {
    "status": "initialized",
    "webhookUrl": "https://example.com/api/telegram/webhook"
  },
  "environment": {
    "nodeEnv": "production",
    "appUrl": "https://unifarm.example.com"
  },
  "memoryUsage": {
    "rss": "120MB",
    "heapTotal": "80MB",
    "heapUsed": "65MB"
  }
}
```

### Перезапуск соединения с БД

```
POST /api/db/reconnect?admin_key=YOUR_ADMIN_SECRET
```

Пример ответа:
```json
{
  "success": true,
  "reconnected": true,
  "previous": {
    "isConnected": false,
    "connectionName": null,
    "isMemoryMode": true
  },
  "current": {
    "isConnected": true,
    "connectionName": "Neon.tech",
    "isMemoryMode": false
  },
  "events": {
    "before": [...],
    "after": [...],
    "latest": {...}
  }
}
```

### Просмотр истории событий БД

```
GET /api/db/events?admin_key=YOUR_ADMIN_SECRET&limit=20
```

## Реагирование на проблемы

1. При получении уведомления о переходе в режим in-memory:
   - Проверьте доступность внешней БД (Neon.tech)
   - Используйте `/api/db/reconnect` для восстановления соединения

2. При частых ошибках запросов:
   - Проверьте нагрузку на БД
   - Рассмотрите возможность оптимизации запросов

3. При полном отказе соединения:
   - Убедитесь, что переменные окружения для БД настроены правильно
   - Проверьте сетевой доступ к серверу БД
   - Восстановите соединение через `/api/db/reconnect`