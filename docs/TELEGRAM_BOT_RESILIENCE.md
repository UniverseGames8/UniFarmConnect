# Устойчивость Telegram бота в UniFarm

Этот документ описывает механизмы повышения надежности и устойчивости интеграции с Telegram API в приложении UniFarm.

## Ключевые улучшения

### 1. Механизм автоматических повторных попыток

Для операций с Telegram API реализован механизм автоматических повторных попыток с экспоненциальной задержкой:

- Основные операции (настройка webhook, установка кнопки меню) выполняются с повторными попытками
- Механизм имеет настраиваемые параметры (количество попыток, базовая задержка)
- Применяется экспоненциальный рост задержки между попытками
- Предотвращает прерывание работы приложения из-за временных сбоев в Telegram API

### 2. Улучшенное логирование событий

Добавлено структурированное логирование:

- Входящие обновления логируются в структурированном формате
- Логи содержат только необходимую информацию для отладки
- Подробные данные обновлений доступны только в режиме отладки
- Все ошибки записываются с дополнительным контекстом

### 3. Асинхронная обработка webhook-запросов

Внедрен асинхронный подход к обработке webhook-запросов:

- Быстрый ответ на webhook-запрос от Telegram для предотвращения повторных запросов
- Независимая обработка сообщений после отправки ответа
- Изоляция ошибок обработки от процесса ответа на webhook

### 4. Надежная инициализация бота

Реализована надежная процедура инициализации:

- Проверка наличия всех необходимых переменных окружения
- Корректная обработка ошибок инициализации
- Четкое управление состоянием инициализации бота
- Подробное логирование процесса инициализации

## Примеры использования

### Выполнение операции с повторными попытками

```typescript
const result = await withRetry(
  async () => await someOperation(),
  'название операции',
  3, // максимум попыток
  1000 // базовая задержка в мс
);

if (!result) {
  // Обработка ситуации, когда все попытки неудачны
}
```

### Асинхронная обработка webhook

Обработчик webhook быстро отвечает Telegram и затем асинхронно обрабатывает данные:

```typescript
// Быстро отвечаем на запрос
res.status(200).send('OK');

// Асинхронная обработка после ответа
try {
  await processUpdate(update);
} catch (error) {
  logger.error('Ошибка при обработке:', error);
}
```

## Диагностика проблем

### Проверка статуса бота

Для проверки статуса бота используйте API эндпоинт:

```
GET /api/telegram/status
```

Ответ содержит подробную информацию о состоянии:

```json
{
  "success": true,
  "data": {
    "hasToken": true,
    "miniAppUrl": "https://example.com",
    "webhookUrl": "https://example.com/api/telegram/webhook",
    "webhookInfo": { ... },
    "webhookError": null,
    "menuText": "Открыть UniFarm",
    "version": "1.0.0",
    "lastInitialized": "2025-05-22T10:15:30.123Z"
  }
}
```

### Проверка и обновление webhook

Для проверки и обновления webhook используйте:

```
GET /api/telegram/check-webhook
```

## Дополнительные настройки

### Режим отладки Telegram

Для включения подробного логирования Telegram установите переменную окружения:

```
DEBUG_TELEGRAM=true
```

Это включит запись полных данных обновлений и дополнительную диагностическую информацию.