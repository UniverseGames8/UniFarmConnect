# Документация по новой архитектуре модулей базы данных

## Проблемы предыдущей архитектуры

Предыдущая архитектура модулей базы данных имела несколько существенных проблем:

1. **Циклические зависимости** между модулями `db-health.ts` и `db-monitor.ts`
2. **Дублирование функциональности** в различных файлах
3. **Отсутствие четкого разделения ответственности** между модулями
4. **Сложности при обновлении соединения** после переподключения к БД
5. **Недостаточная устойчивость** к временным ошибкам соединения

## Новая архитектура

Новая архитектура решает указанные проблемы благодаря четкому разделению ответственности и устранению циклических зависимостей.

### Структура модулей

1. **`db-config.ts`** - Модуль конфигурации подключения к базе данных
   - Содержит только конфигурацию и константы
   - Не имеет зависимостей от других модулей БД
   - Экспортирует типы, перечисления и функции настройки

2. **`db-health-monitor.ts`** - Модуль мониторинга состояния БД
   - Зависит только от `db-config.ts`
   - Объединяет функциональность ранее разделенных `db-health.ts` и `db-monitor.ts`
   - Предоставляет интерфейс для мониторинга и управления состоянием соединения

3. **`db-connect-unified.ts`** - Основной модуль подключения к БД
   - Создает пул подключений и экземпляр Drizzle ORM
   - Зависит от `db-config.ts` и `db-health-monitor.ts`
   - Предоставляет интерфейс для работы с базой данных

4. **`db-adapter.ts`** - Адаптер для совместимости со старым кодом
   - Обеспечивает обратную совместимость с кодом, использующим `db-selector.ts`
   - Делегирует вызовы новым модулям

### Схема зависимостей

```
db-config.ts <---- db-health-monitor.ts <---- db-connect-unified.ts <---- db-adapter.ts
```

## Основные компоненты

### 1. Модуль конфигурации (db-config.ts)

Содержит:
- Типы и интерфейсы для конфигурации соединения
- Перечисления для типов БД и режимов SSL
- Функции для определения типа БД и получения конфигурации
- Не имеет состояния и активных соединений

### 2. Модуль мониторинга (db-health-monitor.ts)

Содержит:
- Класс `DatabaseMonitor` для мониторинга состояния соединения
- Функции для проверки соединения и переподключения
- Сбор статистики и обработку ошибок подключения

### 3. Модуль подключения (db-connect-unified.ts)

Содержит:
- Экземпляр пула подключений и Drizzle ORM
- Интерфейс для работы с базой данных
- Функции обработки ошибок и повторных запросов

### 4. Адаптер (db-adapter.ts)

Содержит:
- Интерфейс, совместимый с `db-selector.ts`
- Делегирование вызовов новым модулям
- Преобразование типов данных для совместимости

## Преимущества новой архитектуры

1. **Устранение циклических зависимостей**
   - Четкая однонаправленная иерархия зависимостей
   - Улучшенная производительность при импорте

2. **Повышенная надежность**
   - Автоматическое восстановление соединения
   - Повторение запросов при временных ошибках

3. **Улучшенная масштабируемость**
   - Модули могут обновляться независимо
   - Легкость добавления новых функций

4. **Улучшенная поддержка кода**
   - Четкое разделение ответственности
   - Упрощенный процесс отладки

## Использование

### Основное использование (новый код)

```typescript
import { db, pool, testConnection } from './db-connect-unified';

// Проверка соединения
const isConnected = await testConnection();

// Выполнение запроса через Drizzle ORM
const users = await db.query.users.findMany();

// Выполнение произвольного SQL-запроса
const client = await pool.connect();
try {
  const result = await client.query('SELECT NOW()');
  console.log(result.rows[0]);
} finally {
  client.release();
}
```

### Совместимость со старым кодом

```typescript
import { db, pool, testDatabaseConnection } from './db-adapter';

// Проверка соединения (старый формат)
const connectionResult = await testDatabaseConnection();
if (connectionResult.success) {
  console.log('Connected to database, server time:', connectionResult.now);
}

// Остальной код остается без изменений
```

## Тестирование новой архитектуры

Для тестирования новой архитектуры создан специальный API-маршрут:

```
GET /api/admin/db-unified-test
```

Этот маршрут проверяет:
1. Соединение с базой данных
2. Выполнение тестового запроса
3. Получение статистики мониторинга

## Миграция

Миграция с предыдущей архитектуры к новой:

1. Обновить импорты с `db-selector.ts` на `db-adapter.ts`
2. Для нового кода использовать напрямую `db-connect-unified.ts`
3. Постепенно обновить контроллеры и сервисы для использования новых функций

## Заключение

Новая архитектура модулей базы данных значительно повышает надежность, масштабируемость и поддерживаемость кода. Благодаря адаптеру обеспечивается плавная миграция со старой архитектуры на новую без прерывания работы приложения.